{% comment %}
Copyright 2012 Julie Smith.  All Rights Reserved.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.


This is the Django template used by tasks-backup.py to display progress to the user, and once the backup is complete,
to allow the user to choose what to do with the retrieved data (export as file, email, or display as a web page).


We store the user's selections in a cookie when a form is submitted. This is so that we can set the user's last 
chosen options when we return to this page, especially if returning after re-authenticating, but also useful 
when user returns from displaying tasks web page display.

Note that this page uses the include_completed, include_hidden and include_deleted variables to selectively include/exclude 
the relevant parts of Javascript and HTML for those functions. Whether these options are available depends on
the selections that the user made when they started the backup.

{% endcomment %}
<!doctype html>
<html>
    <head>
        {% if status == "Starting" or status = "Initialising" or status == "Building"  or status == "Importing" %}
            <meta http-equiv="refresh" content="{{ refresh_interval }}">
        {% endif %}
        
        <title>{{ app_title }}</title>
        <link rel="stylesheet" type="text/css" href="/static/tasks_backup.css" />
        <link rel="shortcut icon" type="image/x-icon" href="/static/favicon.ico" />
        
        <script type="text/javascript" src="/static/jquery.js"></script>
        <script type="text/javascript" src="/static/popup.js"></script>
        <script language="javascript" type="text/javascript" src="/static/datetimepicker.js">
            //Date Time Picker script- by TengYong Ng of http://www.rainforestnet.com
            //Script featured on JavaScript Kit (http://www.javascriptkit.com)
            //For this script, visit http://www.javascriptkit.com 
        </script>
        
        <script type="text/javascript">
        
            {% include "inc_cookies.js" %}
            
            function saveSavedSelectedIndex(obj) {
                if (typeof(obj) == "string") {
                    // User passed in the name of the object
                    obj = document.getElementById(obj);
                }
                if (obj.selectedIndex != obj._savedIndex) {
                    // Save the value as a cookie
                    setCookie(obj.id + "_idx", obj.selectedIndex, 3650);
                    obj._savedIndex = obj.selectedIndex;
                }
            
            }

            function setSavedSelectedIndex(obj) {
                if (typeof(obj) == "string") {
                    // User passed in the name of the object
                    obj = document.getElementById(obj);
                }
                var idx = getCookie(obj.id + "_idx");
                if (idx) {
                    document.getElementById(obj.id).selectedIndex = idx;
                }
            }

            // Store the export format, timezone and display selections
            function storeSelections(actionId) {
                setCookie('export_format', $('input[name=export_format]:checked').val(), 3650); // Radio button
                setCookie('due_selection', $('input[name=due_selection]:checked').val(), 3650); // Radio button
                setCookie('due_year', $('input[name=due_year]').val(), 0); // Hidden input
                setCookie('due_month', $('input[name=due_month]').val(), 0); // Hidden input
                setCookie('due_day', $('input[name=due_day]').val(), 0); // Hidden input
                setCookie('display_invalid_tasks', $('input[name=display_invalid_tasks]:checked').val(), 3650); // Checkbox
                setCookie('display_due_date_field', $('input[name=display_due_date_field]:checked').val(), 3650); // Checkbox
                {% if include_completed %}
                    setCookie('display_completed_tasks', $('input[name=display_completed_tasks]:checked').val(), 3650); // Checkbox
                    setCookie('dim_completed_tasks', $('input[name=dim_completed_tasks]:checked').val(), 3650); // Checkbox
                    setCookie('display_completed_date_field', $('input[name=display_completed_date_field]:checked').val(), 3650); // Checkbox
                {% endif %}
                {% if include_hidden %}
                    setCookie('display_hidden_tasks', $('input[name=display_hidden_tasks]:checked').val(), 3650); // Checkbox
                {% endif %}
                {% if include_deleted %}
                    setCookie('display_deleted_tasks', $('input[name=display_deleted_tasks]:checked').val(), 3650); // Checkbox
                {% endif %}
                setCookie('display_updated_date_field', $('input[name=display_updated_date_field]:checked').val(), 3650); // Checkbox
                setCookie('export_using_localtime', $('input[name=export_using_localtime]:checked').val(), 3650); // Checkbox
                setCookie('display_using_localtime', $('input[name=display_using_localtime]:checked').val(), 3650); // Checkbox
                saveSavedSelectedIndex('display_offset_hours');
                saveSavedSelectedIndex('export_offset_hours');
                
                setCookie('actionId', actionId, 0)
            }
            
            // Restore the user's previous selections
            function restoreSelections() {
                var efVal = getCookie('export_format');
                if (efVal != null && efVal != '') {
                    $('input:radio[name=export_format][value=' + efVal + ']').click(); // Radio button
                }
                var dsVal = getCookie('due_selection');
                if (dsVal != null && dsVal != '') {
                    $('input:radio[name=due_selection][value=' + dsVal + ']').click(); // Radio button
                }
                var due_year = getCookie('due_year');
                var due_month = getCookie('due_month');
                var due_day = getCookie('due_day');
                if (due_year && due_month && due_day) {
                    setDateFields(due_day, due_month, due_year);
                } else {
                    // No stored due date, so use today
                    setCurrentDueDate();
                }
                $('input[name=display_invalid_tasks]').prop('checked', (getCookie('display_invalid_tasks')=='True')); // Checkbox
                {% if include_completed %}
                    $('input[name=display_completed_tasks]').prop('checked', (getCookie('display_completed_tasks')=='True')); // Checkbox
                    $('input[name=dim_completed_tasks]').prop('checked', (getCookie('dim_completed_tasks')=='True')); // Checkbox
                    $('input[name=display_completed_date_field]').prop('checked', (getCookie('display_completed_date_field')=='True')); // Checkbox
                {% endif %}
                {% if include_hidden %}
                    $('input[name=display_hidden_tasks]').prop('checked', (getCookie('display_hidden_tasks')=='True')); // Checkbox
                {% endif %}
                {% if include_deleted %}
                    $('input[name=display_deleted_tasks]').prop('checked', (getCookie('display_deleted_tasks')=='True')); // Checkbox
                {% endif %}
                $('input[name=display_due_date_field]').prop('checked', (getCookie('display_due_date_field')=='True')); // Checkbox
                $('input[name=display_updated_date_field]').prop('checked', (getCookie('display_updated_date_field')=='True')); // Checkbox
                $('input[name=export_using_localtime]').prop('checked', (getCookie('export_using_localtime')=='True')); // Checkbox
                $('input[name=display_using_localtime]').prop('checked', (getCookie('display_using_localtime')=='True')); // Checkbox
                
                // Preselect the user's chosen timezones
                setSavedSelectedIndex('display_offset_hours');
                setSavedSelectedIndex('export_offset_hours');
            }
            
            function disableDisplayHtmlButton() {
                document.getElementById("display-tasks-button").value = "Building display page (this may take many minutes) ...";
                document.getElementById("display-tasks-button").innerHTML = "Building display page (this may take many minutes) ...";
                document.getElementById("display-tasks-button").disabled = true;
                // Also disable retrieve button, since clicking it after display button 
                // has been clicked, results in display process being interrupted. 
                // Display button stays disabled, user get selected download file, 
                // but user never sees the display page.
                document.getElementById("retrieve-tasks-button").disabled = true;
            }
            
            // Set sensible suboptions when user selects "display completed tasks"
            function changeCompletedSuboptions() {
                if (document.getElementById("display_completed_tasks").checked) 
                {
                    document.getElementById("dim_completed_tasks").checked = true; // Default
                    document.getElementById("dim_completed_tasks").disabled = false;
                    document.getElementById("display_completed_date_field").checked = true;
                    document.getElementById("display_completed_date_field").disabled = false;
                } else {
                    document.getElementById("dim_completed_tasks").checked = false;
                    document.getElementById("dim_completed_tasks").disabled = true;
                    document.getElementById("display_completed_date_field").checked = false;
                    document.getElementById("display_completed_date_field").disabled = true;
                }
            }
            
            // Uncheck "display completed tasks" is user selects a due date, as completed tasks 
            // are not displayed when user selects only due tasks
            function changeCompletedOptions() {
                if (document.getElementById("due_selection_any_due").checked ||
                    document.getElementById("due_selection_due_now").checked ||
                    document.getElementById("due_selection_overdue").checked)
                {
                    e = false;
                } else {
                    e = true;
                }
                document.getElementById("display_completed_tasks").checked = e;
                changeCompletedSuboptions();
            }
            
            // If a completed sub-option is selected, then "display completed tasks" must be selected
            function changeDisplayCompleted() {
                if (document.getElementById("dim_completed_tasks").checked ||
                    document.getElementById("display_completed_date_field").checked) 
                {
                    document.getElementById("display_completed_tasks").checked = true;
                }
            }
            
            // Set hidden date value fields, and display date in human-friendly format
            function setDateFields(day, month, year) {
                // Also called when a user clicks on a date in the calendar created by datetimepicker.js
                // Each date cell created by GenCell() is a link to this javascript method, with the
                // appropriate day, month, year values.
                document.getElementById("due_year").value = Number(year);
                document.getElementById("due_month").value = Number(month);
                document.getElementById("due_day").value = Number(day);
                yearStr = "0000" + year.toString();
                yearStr = yearStr.substring(yearStr.length - 4);
                monthStr = "00" + month.toString();
                monthStr = monthStr.substring(monthStr.length -2);
                dayStr = "00" + day.toString();
                dayStr = dayStr.substring(dayStr.length - 2);
                document.getElementById("due_date").innerHTML = yearStr + "-" + monthStr + "-" + dayStr;
            }
            
            // Set the current date, which is used to filter due tasks.
            function setCurrentDueDate() {
                // We take the date from the browser, so that the due date is today in the user's current timezone is used
                var today = new Date();
                // JS month == 0..11, so add one to .getMonth()
                setDateFields(today.getDate(), 1 + today.getMonth(), today.getFullYear());
            }
            
            // Various actions to take when page is loaded. Actions depend on whether there are any previous settings stored in cookies.
            function pageLoadActions() {
                {% if status == "Export completed" %}
                    // Check if there are any stored values, by retrieving the 'export_format' cookie, because we always save that cookie.
                    var export_format = getCookie('export_format')
                    if (export_format) 
                    {
                        // 'export_format' cookie exists, so there are saved values that we should use
                        restoreSelections();
                        // Check if the user's selection was actioned in ReturnResultsHandler.post() in tasks-backup.py
                        //     If authentication is OK, the actionId cookie is deleted in ReturnResultsHandler.post()
                        //         and the user's selection is actioned
                        //     If authentication failed when the user's selection was submitted to /results, 
                        //         then the user's selection was NOT actioned, so we do it here.
                        var actionId = getCookie('actionId');
                        if (actionId) {
                            eraseCookie('actionId');
                            // Perform the action that the user selected
                            $('#' + actionId).click();
                        }
                    }
                    else 
                    {
                        // No stored values, so set up defaults
                        {% if include_completed %}
                            changeCompletedSuboptions(); 
                            changeCompletedOptions(); 
                            changeDisplayCompleted(); 
                        {% endif %}
                        setCurrentDueDate();
                    }
                {% endif %}
            }
            
            // Check if the user has chosen a localtime offset for a potentially problematic export format (a format that expects UTC) 
            function checkExportForm(frm) {
            
                if (frm.export_using_localtime.checked) {
                    var exportFormatMessages = {
                        'ics'           : "ICS format, because that format expects UTC date/times.",
                        'gtb'           : "GTBak format, because it is designed to be imported into Google Tasks, which uses UTC date/times.",
                        'import_export' : "Import/Export CSV format, because it is designed to be imported into Google Tasks, which uses UTC date/times."
                    }
                    
                    var exportFomat = $('input[name=export_format]:checked').val();
                    
                    var exportFormatMessage = exportFormatMessages[exportFomat];
                    if (exportFormatMessage) {
                        var r=confirm("It is not advisable to adjust for local time when using the " + 
                            exportFormatMessage + "\n\nAre you sure that you want to adjust for local time?");
                        if (r==false) {
                            // Don't submit the form
                            return false;
                        }
                    }
                }        
                
                // All OK
                return true;
            }
            
        
        </script>
        {% include "inc_google_analytics.html" %}
    </head>

<body onload="pageLoadActions();" > 
    {% include "inc_user_header.html" %}
    
    {% if display_link_to_production_server %}
        {% include "inc_limited_access_server_msg.html" %}
    {% endif %}

    <noscript>
        <br />
        <h3>Javascript must be enabled for full application functionality</h3>
        <br />
    </noscript>
    
    {% if host_msg %}
        <div class="break">
            <h3>{{ host_msg }}</h3>
        </div>
    {% endif %}

    {% include "inc_mar_2019_subtasks_warning.html" %}
    
    {% if msg %}
        <div class="break">
            <p>Msg = {{ msg }}</p>
		</div>
    {% endif %}
    
    {% if status == "Starting" or status = "Initialising" or status == "Building" %}
        <div class="break">
            This page will auto-refresh every {{ refresh_interval }} seconds to indicate how many tasks have been retrieved so far.
        </div>
    {% endif %}
    
    {% if status == "Export completed" %}
        <div class="break">
            {{ job_msg }} <img class="popupTrigger" id="export-completed" src="/static/help.png" alt="Display help">
            <div class="popupContent" id="export-completed-content">
                <img class="popupClose" border="0" src="/static/close.png" alt="Close">
                <div class="clear medium-break">
                    This backup is a snapshot of tasks as at {{ job_start_timestamp }} UTC 
                    and will not reflect changes to Google Tasks made after that time. 
                    <a class="no-visited-highlight" href="{{ url_main_page }}" >Click here</a> to create a new backup.
                </div>
            </div>
            
            {% if include_completed %}
                <br/>
                <span class="comment">Includes completed tasks</span>
            {% else %}
                <br/>
                <span class="comment">Excludes completed tasks</span>
            {% endif %}
            {% if include_hidden %}
                <br/>
                <span class="comment">Includes hidden tasks</span>
            {% endif %}
            {% if include_deleted %}
                <br/>
                <span class="comment">Includes deleted tasks</span>
            {% endif %}
                        
            {% if possibly_very_stale_data %}
                <div class="warning-box take-note-larger medium-gap-top small-break">
                    <div class="take-note-larger">
                        <span class="take-note-larger">CAUTION: This backup snapshot was made {{ since_msg }}</span>.
                    </div>
                    <div class="take-note nice-gap-top">
                        If you want to export or display tasks created or modified since {{ job_start_timestamp_str }},<br> 
                        please <a class="take-note-larger no-visited-highlight" href="{{ url_main_page }}">click here to create a new backup</a>
                    </div>
                </div>
            {% else %}
                {% if possibly_stale_data %}
                    <div class="take-note-larger medium-gap-top small-break">
                        NOTE: This backup snapshot was made {{ since_msg }}.
                    </div>
                    <div class="take-note nice-gap-top">
                        If you want to export or display tasks created or modified since {{ job_start_timestamp_str }},<br> 
                        please <a class="no-visited-highlight" href="{{ url_main_page }}">click here to create a new backup</a>
                    </div>
                {% endif %}
            {% endif %}
        </div>
    {% else %}
        {% if status == "Starting" %}
            <div class="break">
                Starting new backup job, please wait (this may take several minutes) ...
            </div>
        {% else %}
            <div class="break">
                Status = {{ status }}
            </div>
        {% endif %}
        {% if progress > 0 %}
            <div class="break">
                Progress = {{ progress }}
            </div>
        {% endif %}
        {% if job_msg %}
            <div class="break">
                {{ job_msg }}
            </div>
        {% endif %}
    {% endif %}

            
    
    {% if error_message %}
        <br />
        <br />
        <br />
        <div class="take-note break">
            {{ error_message }}
        </div>
        <div class="break">
            Please report this error at <a href="http:/{{ url_issues_page }}">{{ url_issues_page }}</a>
        </div>
        <br />
        <br />
        <br />
    {% endif %}
    
    {% if status == "Export completed" %}
        <!-- Choose format to return backup data -->
        <form method="POST" action="{{ results_url }}" onsubmit="storeSelections('retrieve-tasks-button'); return checkExportForm(this)" >
        
			<fieldset>
				<legend>Export all tasks</legend>
				<table  cellspacing="0" class="format-selection">
					<!--<col width="20%">
					<col width="80%">-->
					<tr>
						<td class="format-name">
							<input id="format_outlook" type="radio" name="export_format" value="outlook" checked="checked" /> Outlook CSV<br />
						</td>
						<td>
							CSV file suitable for importing into Outlook.
						</td>
					</tr>
					<tr>
						<td class="format-name">
							<input id="format_ics" type="radio" name="export_format" value="ics" /> iCal ICS<br />
						</td>
						<td>
							iCal .ICS file suitable for importing into many calendar applications.
						</td>
					</tr>
					<tr>
						<td class="format-name">
							<input id="format_raw" type="radio" name="export_format" value="raw" /> Raw CSV<br />
						</td>
						<td>
							CSV file containing almost all available properties for each task.
                            <br />
                            See the <a href="/static/info.html">information page</a> for details.
						</td>
					</tr>
					<tr>
						<td class="format-name">
							<input id="format_raw1" type="radio" name="export_format" value="raw1" /> Raw CSV, formatted dates<br />
						</td>
						<td>
							Same as Raw CSV, but with date/timestamps formatted suitable for reading by Excel.
						</td>
					</tr>
                    
					<tr>
						<td class="format-name">
							<input id="format_raw2" type="radio" name="export_format" value="raw2" /> Raw CSV, RFC3339 timestamps<br />
						</td>
						<td>
							Same as Raw CSV, but also includes timestamps in RFC3339 format.
                            <img class="popupTrigger" id="help-raw2" src="/static/help.png" alt="Display help">
                            <div class="popupContent" id="help-raw2-content">
                                <img class="popupClose" border="0" src="/static/close.png" alt="Close">
                                <div class="clear medium-break">
                                    In addition to yyyy-mm-dd format for 'due', 'completed' and 'updated' fields, this file also includes the timestamps in the original RFC-3339 format .
                                </div>
                                <div class="medium-break">
                                    This format is primarily intended for debugging purposes.
                                </div>
                            </div>
						</td>
					</tr>
                    
					<tr>
						<td class="format-name">
							<input id="format_import_export" type="radio" name="export_format" value="gtb" /> Import/Export GTBak<br />
						</td>
						<td>
							The GTBak format is designed to be used by 
                            <a href="http://import-tasks.appspot.com">Google Tasks Import</a> to import tasks.
                            Unlike the CSV format, this format retains international and extended characters.
                            <img class="popupTrigger" id="help-gtb" src="/static/help.png" alt="Display help">
                            <div class="popupContent" id="help-gtb-content">
                                <img class="popupClose" border="0" src="/static/close.png" alt="Close">
                                <div class="clear medium-break">
                                    This format is used by 
                                    <a class="take-note" href="http://import-tasks.appspot.com">Google Tasks Import</a>, which 
                                    can be used to import tasks into the same or a different Google account.
                                </div>
                                <div class="medium-break">
                                    Whereas the CSV format may lose international and extended characters, this format should retain all characters.
                                </div>
                                <div class="medium-break">
                                    Unlike the CSV format, the GTBak format is not easily edited by the user. The file is encoded using Python 
                                    <a href="http://docs.python.org/library/pickle.html">pickle serialisation</a> to ensure that no extended character information is lost or modified.
                                </div>
                                <div class="medium-break">
                                    This format backs up everything except Task Links. 
                                </div>
                                <div class="comment medium-break ">
                                    As far as I am aware, the only use for Task Links is when an email message is turned into a task; 
                                    the link then refers to the original email message.
                                    If tasks are restored into a different account, Task Links would not work (because they would refer to messages in another account).
                                </div>
                            </div>
						</td>
					</tr>

					<tr>
						<td class="format-name">
							<input id="format_import_export" type="radio" name="export_format" value="import_export" /> Import/Export CSV&nbsp;
                            <img class="popupTrigger" id="help-import_export_csv" src="/static/warning.png" alt="Display warning">
                            <div class="popupContent" id="help-import_export_csv-content">
                                <img class="popupClose" border="0" src="/static/close.png" alt="Close">
                                <div class="clear medium-break force-normal-white-space">
                                    <span class="take-note" style="color:red;">CAUTION:</span> The CSV format may lose or incorrectly interpret international 
                                    or extended characters. To ensure maximum character integrity when importing tasks using  
                                    <span class="take-note">Google Tasks Import</span>, use the <span class="take-note">GTBak</span> format instead.
                                </div>
                            </div>
                            
                            <br />
						</td>
						<td>
							CSV file containing just the data required to recreate tasks. 
                            <img class="popupTrigger" id="help-import_export" src="/static/help.png" alt="Display help">
                            <div class="popupContent" id="help-import_export-content">
                                <img class="popupClose" border="0" src="/static/close.png" alt="Close">
                                <div class="clear medium-break">
                                    See the <a href="/static/info.html#import_export_description">information page</a> for details of the file format.
                                </div>
                                <div class="medium-break">
                                    This format can be used by 
                                    <a class="take-note" href="http://import-tasks.appspot.com">Google Tasks Import</a>, which 
                                    can be used to import tasks into the same or a different Google account. 
                                </div>
                                <div class="medium-break">
                                    The file can be edited in a text editor such as <a href="http://notepad-plus-plus.org/">Notepad++</a>
                                    before being imported. It is not recommended to edit this file with a spreadsheet program, 
                                    as programs such as Excel and OpenOffice Calc tend to corrupt the data.
                                </div>
                                <div class="medium-break">
                                    <span class="take-note" style="color:red;">CAUTION:</span> The CSV format may lose or incorrectly interpret international 
                                    or extended characters. To ensure maximum character integrity when importing tasks using  
                                    <span class="take-note">Google Tasks Import</span>, use the <span class="take-note">GTBak</span> format instead.
                                </div>
                                <div class="medium-break">
                                    This format backs up everything except Task Links. 
                                </div>
                                <div class="comment medium-break ">
                                    As far as I am aware, the only use for Task Links is when an email message is turned into a task; 
                                    the link then refers to the original email message.
                                    If tasks are restored into a different account, Task Links would not work (because they would refer to messages in another account).
                                </div>
                            </div>
						</td>
					</tr>
                    
                    <tr>
                        <td class="format-name">
                            <input id="format_python" type="radio" name="export_format" value="py" /> Python<br />
                        </td>
                        <td>
                            Python data structure. Contains all the properties stored by Google for each task. 
                            See the <a href="/static/info.html">information page</a> for details.
                        </td>
                    </tr>
                    
{% if show_log_option %}                     
					<tr>
						<td class="format-name">
							<input id="format_log" type="radio" name="export_format" value="log" /> Log file<br />
						</td>
						<td>
							Data used to check task order
						</td>
					</tr>
{% endif %}                    

					<tr>
						<td class="format-name">
							<input id="format_RTM" type="radio" name="export_format" value="RTM" /> RTM email<br />
						</td>
						<td>
							Email tasks in Remember The Milk format.
                            <img class="popupTrigger" id="help-rtm" src="/static/help.png" alt="Display help">
                            <div class="popupContent" id="help-rtm-content">
                                <img class="popupClose" src="/static/close.png" alt="Close">
                                <ol class="clear">
                                    <li>
                                        Attempting to email very large tasklists may fail due to App Engine email quota limits.
                                    </li>
                                    <li>
                                        It appears that RTM will not import more than 50 tasks.
                                    </li>
                                    <li>
                                        Any header text must be removed before forwarding the received email to your RTM import email address. The first line in the email must be a task.
                                    </li>
                                </ol>
                            </div>
						</td>
					</tr>
                    
					<tr>
						<td class="format-name">
							<input id="format_spaced_text" type="radio" name="export_format" value="spaced_text" /> Spaced text file<br />
						</td>
						<td>
							Text file which uses spaces to indent tasks, subtasks and notes.
                            <img class="popupTrigger" id="help-spaced_text" src="/static/help.png" alt="Display help">
                            <div class="popupContent" id="help-spaced_text-content">
                                <img class="popupClose" src="/static/close.png" alt="Close">
                                <div class="clear">
                                    Spaced text file format;<br />
                                    <ol>
                                        <li>The tasklist name is not indented</li>
                                        <li>Root-level tasks are indented by 2 spaces</li>
                                        <li>The due date (if specified) is indented at the same level as the task name</li>
                                        <li>Notes (if specified) are indented by a further 2 spacess</li>
                                        <li>Sub-tasks are indented by additional 6 spaces per sub-task-level</li>
                                    </ol>
                                    
                                </div>
                                
                                <div class="medium-break">
                                    <u>For example;</u>
                                </div>
                                
                                <div class="fixed-font take-note-larger">
                                    <span class="take-note-larger">
                                        ======================================<br />
                                        Tasklist1 name<br />
                                        --------------------------------------<br />
                                        <br />
                                        &nbsp;&nbsp;Task1 name<br />
                                        &nbsp;&nbsp;DUE: yyyy-mm-dd<br />
                                        &nbsp;&nbsp;&nbsp;&nbsp;Task1 notes line 1<br />
                                        &nbsp;&nbsp;&nbsp;&nbsp;Task1 notes line 2<br />
                                        <br />
                                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subtask1.1 name<br />
                                        <br />
                                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subtask1.2 name<br />
                                        <br />
                                        &nbsp;&nbsp;x Task2 name<br />
                                        &nbsp;&nbsp;&nbsp;&nbsp;Notes for task 2, which has been<br />
                                        &nbsp;&nbsp;&nbsp;&nbsp;completed (indicated by the x)<br />
                                        <br />
                                        &nbsp;&nbsp;Task3 name<br />
                                        &nbsp;&nbsp;&nbsp;&nbsp;Task3 notes<br />   
                                        <br />
                                        ======================================<br />
                                        Tasklist2 name<br />
                                        --------------------------------------<br />
                                        <br />
                                        &nbsp;&nbsp;Task1 name<br />
                                        <br />
                                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subtask1.1 name<br />
                                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DUE: yyyy-mm-dd<br />
                                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subtask1.1 notes<br />
                                        <br />
                                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subtask1.1.1 name<br />
                                        <br />
                                    </span>
                                </div>
                            </div>
						</td>
					</tr>
                    
					<tr>
						<td class="format-name">
							<input id="format_tabbed_text" type="radio" name="export_format" value="tabbed_text" /> Tabbed text file<br />
						</td>
						<td>
							Text file which uses tabs to indent tasks, subtasks and notes.
                            <img class="popupTrigger" id="help-tabbed_text" src="/static/help.png" alt="Display help">
                            <div class="popupContent" id="help-tabbed_text-content">
                                <img class="popupClose" src="/static/close.png" alt="Close">
                                <div class="clear">
                                    Tabbed text file format;<br />
                                    <ol>
                                        <li>The tasklist name is not indented</li>
                                        <li>Root-level tasks are indented by 1 tab</li>
                                        <li>The due date (if specified) is indented at the same level as the task name</li>
                                        <li>Notes (if specified) are indented by 2 tabs</li>
                                        <li>Sub-tasks are indented by an additional 2 tabs per sub-task-level</li>
                                        <li>An odd number of indents indicates a task title, or due date</li>
                                        <li>An even number of indents indicates a note</li>
                                    </ol>
                                    
                                </div>
                                
                                <div class="medium-break">
                                    <u>For example;</u>
                                </div>
                                
                                <div class="fixed-font  take-note-larger">
                                    ======================================<br />
                                    <span class="take-note-larger">Tasklist1 name</span><br />
                                    --------------------------------------<br />
                                    <br />
                                    <span class="take-note-smaller">&lt;tab&gt;</span><span class="take-note-larger">Task1 name</span><br />
                                    <span class="take-note-smaller">&lt;tab&gt;</span><span class="take-note-larger">DUE:yyyy-mm-dd</span><br />
                                    <span class="take-note-smaller">&lt;tab&gt;&lt;tab&gt;</span><span class="take-note-larger">Task1 notes line 1</span><br />
                                    <span class="take-note-smaller">&lt;tab&gt;&lt;tab&gt;</span><span class="take-note-larger">Task1 notes line 2</span><br />
                                    <br />
                                    <span class="take-note-smaller">&lt;tab&gt;&lt;tab&gt;&lt;tab&gt;</span><span class="take-note-larger">Subtask1.1 name</span><br />
                                    <br />
                                    <span class="take-note-smaller">&lt;tab&gt;&lt;tab&gt;&lt;tab&gt;</span><span class="take-note-larger">Subtask1.2 name</span><br />
                                    <br />
                                    <span class="take-note-smaller">&lt;tab&gt;</span><span class="take-note-larger">x Task2 name</span><br />
                                    <span class="take-note-smaller">&lt;tab&gt;&lt;tab&gt;</span><span class="take-note-larger">This is a completed task</span><br />
                                    <br />
                                    <span class="take-note-smaller">&lt;tab&gt;</span><span class="take-note-larger">Task3 name</span><br />
                                    <span class="take-note-smaller">&lt;tab&gt;&lt;tab&gt;</span><span class="take-note-larger">Task3 notes</span><br />   
                                    <br />
                                    ======================================<br />
                                    <span class="take-note-larger">Tasklist2 name</span><br />
                                    --------------------------------------<br />
                                    <br />
                                    <span class="take-note-smaller">&lt;tab&gt;</span><span class="take-note-larger">Task1 name</span><br />
                                    <br />
                                    <span class="take-note-smaller">&lt;tab&gt;&lt;tab&gt;&lt;tab&gt;</span><span class="take-note-larger">Subtask1.1 name</span><br />
                                    <span class="take-note-smaller">&lt;tab&gt;&lt;tab&gt;&lt;tab&gt;</span><span class="take-note-larger">DUE: yyyy-mm-dd</span><br />
                                    <span class="take-note-smaller">&lt;tab&gt;&lt;tab&gt;&lt;tab&gt;&lt;tab&gt;</span><span class="take-note-larger">Subtask1.1 notes</span><br />
                                    <br />
                                    <span class="take-note-smaller">&lt;tab&gt;&lt;tab&gt;&lt;tab&gt;&lt;tab&gt;&lt;tab&gt;</span><span class="take-note-larger">Subtask1.1.1 name</span><br />
                                    <br />
                                </div>
                            </div>
						</td>
					</tr>
                    
                    <tr>
                        <td>
                            <br />
                            <div class="break">
                                <input type="checkbox" name="export_using_localtime" id="export_using_localtime" value="True">
                                    &nbsp;Adjust for local timezone?
                                
                                <img class="popupTrigger" id="help-timezone" src="/static/help.png" alt="Display help">
                                <div class="popupContent" id="help-timezone-content">
                                    <img class="popupClose" border="0" src="/static/close.png" alt="Close">
                                    <div class="clear medium-break">
                                        This option allows GTB to add or subtract the specified number of hours from the 'completed' and 'updated' fields, in an attempt to correct for the difference between the local time and the Google Tasks server time (which uses UTC).
                                    </div>
                                    <div class="break comment">
                                        The Google Tasks server records the time that tasks are updated or completed using its own clock, which uses UTC (aka GMT). By default, GTB returns these values exactly as stored on the Google Tasks server.
                                    </div>
                                    <div>
                                        This option is most useful when using the Outlook export format.
                                    </div>
                                    <div class="medium-break">
                                        <span style="color:red;">CAUTION:</span> Using this option to adjust for local timezone may result in incorrect completed date/time
                                        if the exported file expects UTC.
                                    </div>
                                    <div class="break comment">
                                        For example;
                                        <ul style="margin-top: 0px;">
                                            <li>The <span class="take-note">ICS</span> format specifies times in UTC, so any applications using an ICS file will expect those date/times to be UTC (not local time).</li>
                                            <li>The <span class="take-note">GTBak</span> and <span class="take-note">Import/Export CSV</span> formats are designed to be imported back into Google Tasks, which interpets all times as UTC. If the export file does not contain UTC date/times, the completed dates may be displayed incorrectly in Google Tasks.</li>
                                        </ul>
                                    </div>
                                    <div class="medium-break">
                                        The biggest impact of the difference between local time and UTC is that a task exported by GTB may appear to have been completed on the previous or next day when imported into another application (e.g. Outlook).
                                    </div>
                                    <div class="medium-break comment">
                                        For example;
                                        <ul style="margin-top: 0px;">
                                            <li>
                                                If a user in New York (UTC-5) marks a task complete after 7:00 pm, the task will appear to have been completed on the next day, because the Google Tasks server ticks over past midnight UTC at 7:00pm New York time.
                                            </li>
                                            <li>
                                                If a user in Sydney (UTC+10) marks a task complete before 10:00 am, the task will appear to have been completed on the previous day, because the Google Tasks server doesn't tick over past midnight until 10:00 am Sydney time.
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="medium-break">
                                        This option provides a partial solution, as it allows GTB to add or subtract the specified number of hours from times stored on the Google Tasks server. This will not solve all time offset issues. 
                                    </div>
                                    <div class="medium-break comment">
                                        For example;
                                        <ul style="margin-top: 0px;">
                                            <li>If you were in a different timezone when you completed a task, neither the server nor GTB knows that, so there is no way to report the local time that the task was completed.</li>
                                            <li>GTB cannot compensate for daylight savings time. This means that if a task is completed during daylight savings time, and the export is run during standard time, there will be a one-hour window where tasks may still be reported as being completed on the next or previous day.</li>
                                        </ul>
                                    </div>
                                    <div class="break">
                                        So, in summary, selecting your timezone offset should reduce the number of tasks which appear to have been completed on the previous or next day, but will not entirely eliminate the issue.
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <select name="export_offset_hours" id="export_offset_hours"
                                onclick="document.getElementById('export_using_localtime').checked = true;" 
                                onkeypress="document.getElementById('export_using_localtime').checked = true;">
                                {% include "inc_timezone_options.html" %}
                            </select>
                        </td>
                    </tr>
                </table>
                <br />

				<button type="submit" id="retrieve-tasks-button" class="big-button" value="Export tasks data">Export tasks data</button>
			</fieldset>
        </form>
        
        <div class="break">
        </div>
        

        <form method="POST" action="{{ results_url }}" onsubmit="storeSelections('display-tasks-button'); disableDisplayHtmlButton();" >
        
            <input type="hidden" name="export_format" value="html_raw" />
            <input type="hidden" name="job_start_timestamp" value="{{ job_start_timestamp }}" />
            
            <!-- These values are set by setDateFields(), which is originally called by setCurrentDueDate() on page load.
                 setDateFields() is also called when the user clicks on a date the date picker form.
            -->
            <input type="hidden" id="due_year" name="due_year" value="0001" />
            <input type="hidden" id="due_month" name="due_month" value="1" />
            <input type="hidden" id="due_day" name="due_day" value="1" />
            
            
			<fieldset>
				<legend>
                    Display all tasks as a single web page, suitable for printing
                    <img class="popupTrigger" id="help-display" src="/static/help.png" alt="Display help">
                </legend>
                <div class="popupContent" id="help-display-content">
                    <img class="popupClose" src="/static/close.png" alt="Close">
                    <div class="clear medium-break">
                        The resultant web page will contain all the tasks in all the task lists. 
                        Tasks will be indented to display task/sub-task relationships.
                    </div>
                    <div class="medium-break">
                        There is no pretty formatting, so a page break may occur in the middle of a task.
                    </div>
                    <div class="medium-break">
                        Note that the resultant printout can be MANY pages (especially when tasks have notes). 973 tasks in 7 tasklists resulted in 141 pages.
                    </div>
                </div>
                <div class="format-selection">
                    <div class="left-column">
                        <div class="selection-column-header">
                            Filter by due date <span id="due_date" class="due_date" onclick="javascript:NewCal('due_date')" >0001-01-01</span>&nbsp;
                            <button type="button" onclick="javascript:NewCal('due_date')" >
                                Choose date&nbsp; 
                                <img src="/static/cal.gif" width="16" height="16" border="0" alt="Set due date filter">
                            </button>&nbsp;
                            or&nbsp;<button type="button" onclick="setCurrentDueDate()" >Use today</button>
	  		
                        </div>
                        <noscript>
                            <br />
                            <span class="take-note">Javascript must be enabled to determine current date, and to enable date to be set</span>
                            </noscript>
                        
                        <ul class="format-selection">
                            <li>
                                <input id="due_selection_all" type="radio" name="due_selection" value="all"  checked="checked"
                                       onchange="changeCompletedOptions();" />
                                <label for="due_selection_all">All tasks</label>
                            </li>
                            <li>
                                <input id="due_selection_any_due" type="radio" name="due_selection" value="any_due"
                                       onchange="changeCompletedOptions();" />
                                <label for="due_selection_all">Any tasks with a due date (incl future due)</label>
                            </li>
                            <li>
                                <input id="due_selection_due_now" type="radio" name="due_selection" value="due_now"
                                       onchange="changeCompletedOptions();" />
                                <label for="due_selection_all">Tasks due on or before selected date</label>
                            </li>
                            <li>
                                <input id="due_selection_overdue" type="radio" name="due_selection" value="overdue" 
                                       onchange="changeCompletedOptions();" />
                                <label for="due_selection_all">Overdue only (due before selected data)</label>
                            </li>
                            <li>
                                <input id="due_selection_none" type="radio" name="due_selection" value="none" 
                                       onchange="changeCompletedOptions();" />
                                <label for="due_selection_none">No due date</label>
                            </li>
                        </ul>
                        <div class="selection-column-header">Other task filters</div>
                        <ul class="format-selection">
                            <li>
                                <input type="checkbox" name="display_invalid_tasks" value="True" >
                                    &nbsp;Display parentless, invalid and corrupted tasks? 
                                    <img class="popupTrigger" id="help-invalid" src="/static/help.png" alt="Display help">
                                    <img class="popupTrigger" id="help-invalid" src="/static/warning.png" alt="Display warning">
                                    <div class="popupContent" id="help-invalid-content">
                                        <img class="popupClose" src="/static/close.png" alt="Close">
                                        <div class="clear medium-break">
                                            <span style="color:red;">CAUTION:</span>  It is possible for subtasks to end up in an invalid state, where a subtask's parent is missing, or may not be exported. GTB marks these tasks as invalid, and does not export them to file or email. Refer to <a href="/static/info.html#note4">notes 4 and 5 on the information page</a> for more details.
                                        </div>
                                        <div class="clear medium-break">
                                            If this option is checked, parentless tasks will be displayed and labeled as 
                                            <span class="no-break task-attribute-hidden-or-deleted dim">-&nbsp;Invalid&nbsp;-</span>
                                            on the tasks display page. If this option is unchecked, invalid tasks will not be displayed.
                                        </div>
                                    </div>
                                
                            </li>
                        </ul>
                    </div>
                    
                    <div class="right-column">
                        <div class="selection-column-header">Display options</div>
                        <ul class="format-selection">
                            {% if include_completed %}
                            <li>
                                <input type="checkbox" id="display_completed_tasks" name="display_completed_tasks" value="True" 
                                       checked="checked"  onchange="changeCompletedSuboptions();">
                                    &nbsp;Display completed tasks?
                                
                            </li>
                            <li>
                                <ul class="format-selection sub-list">
                                <li>
                                    <input type="checkbox" id="dim_completed_tasks" name="dim_completed_tasks" value="True" 
                                           onchange="changeDisplayCompleted();" checked="checked" >
                                        &nbsp;Dim completed tasks?
                                    <img class="popupTrigger" id="help-display-completed" src="/static/help.png" alt="Display help">
                                    <div class="popupContent" id="help-display-completed-content">
                                        <img class="popupClose" width="24" height="24" src="/static/close.png" alt="Close">
                                        <div class="clear">
                                            <div class="small-break">
                                                If checked, completed tasks are displayed using a dimmed grey font. 
                                            </div>
                                            <div class="small-break">
                                                If unchecked, completed tasks are displayed normally.
                                            </div>
                                            <div class="small-break">
                                                Hidden and deleted tasks are always dimmed.
                                            </div>
                                        </div>
                                    </div>
                                    
                                </li>
                                <li>
                                    <input type="checkbox" id="display_completed_date_field" name="display_completed_date_field" value="True"  
                                           onchange="changeDisplayCompleted();" checked="checked" >
                                        &nbsp;Display completed date field?
                                    
                                </li>
                                </ul>
                            </li>
                            {% endif %}
                            {% if include_hidden %}
                                <li>
                                    <input type="checkbox" name="display_hidden_tasks" value="True" checked="checked" >
                                        &nbsp;Display hidden tasks?
                                    
                                </li>
                            {% endif %}
                            {% if include_deleted %}
                                <li>
                                    <input type="checkbox" name="display_deleted_tasks" value="True" checked="checked" >
                                        &nbsp;Display deleted tasks?
                                    
                                </li>
                            {% endif %}
                            
                            
                            <li>
                                <input type="checkbox" name="display_due_date_field" value="True" checked="checked" >
                                    &nbsp;Display due date field?
                                
                            </li>
                            <li>
                                <input type="checkbox" name="display_updated_date_field" value="True" >
                                    &nbsp;Display updated date field?
                                
                            </li>
                        </ul>
                        
                        <div class="selection-column-header">Sort order</div>
                        <ul class="format-selection">
                            <li>
                                <input id="html_sort_order_default" type="radio" name="html_sort_order" value=""  checked="checked" />
                                <label for="html_sort_order_default">Default order</label>
                            </li>
                            <li>
                                <input id="html_sort_order_due_date" type="radio" name="html_sort_order" value="due_date"/>
                                <label for="html_sort_order_due_date">Sort by due date (earliest first)</label>
                            </li>
                            <li>
                                <input id="html_sort_order_due_date_reverse" type="radio" name="html_sort_order" value="due_date_reverse"/>
                                <label for="html_sort_order_due_date_reverse">Sort by due date (latest first)</label>
                            </li>
                            <li>
                                <input id="html_sort_order_alphabetically" type="radio" name="html_sort_order" value="alphabetically"/>
                                <label for="html_sort_order_alphabetically">Sort alphabetically</label>
                            </li>
                        </ul>
                    </div>
                </div>
                
				<br />
                
                <div  class="break clear" style="margin-left: 15px">
                    <input type="checkbox" name="display_using_localtime" id="display_using_localtime" value="True">
                        &nbsp;Display times in local timezone?
                    
                    <img class="popupTrigger" id="help-display_local_time" src="/static/help.png" alt="Display help">
                    <div class="popupContent" id="help-display_local_time-content">
                        <img class="popupClose" border="0" src="/static/close.png" alt="Close">
                        <div class="clear medium-break">
                            This option allows GTB to display the 'completed' and 'updated' fields in your local timezone. If this option is unchecked, times will be displayed using the Google Tasks server time (which uses UTC).
                        </div>
                        <div class="break comment">
                            The Google Tasks server records the time that tasks are updated or completed using its own clock, which uses UTC (aka GMT). If this option is unchecked, GTB displays the dates/times exactly as stored on the Google Tasks server.
                        </div>
                        <div class="medium-break">
                            This option attempts to compensate for the difference between the user's local times and the server's UTC time.
                        </div>
                        <div class="medium-break comment">
                            For example;
                            <ul>
                                <li>
                                    If a user in New York (UTC-5) marks a task complete after 7:00 pm, the task will appear to have been completed on the next day, because the Google Tasks server ticks over midnight UTC at 7:00pm New York time.
                                </li>
                                <li>
                                    If a user in Sydney (UTC+10) marks a task complete before 10:00 am, the task will appear to have been completed on the previous day, because the Google Tasks server ticks doesn't tick over midnight until 10:00 am Sydney time.
                                </li>
                            </ul>
                        </div>
                        <div class="medium-break">
                            This option provides a partial solution, as it allows GTB to add or subtract the specified number of hours from times stored on the Google Tasks server. This will not solve all time offset issues. For example;
                            <ul>
                                <li>If you were in a different timezone when you completed a task, neither the server nor GTB knows that, so there is no way to display the local time that the task was completed.</li>
                                <li>GTB cannot compensate for daylight savings time. This means that if a task is completed during daylight savings time, and this page is displayed during standard time, there will be a one-hour window where tasks may still be reported as being completed on the next or previous day.</li>
                            </ul>
                        </div>
                        <div class="break">
                            So, in summary, selecting your timezone offset should reduce the number of tasks which appear to have been completed on the previous or next day, but will not entirely eliminate the issue.
                        </div>
                    </div>

                    &nbsp;&nbsp;

                    <select name="display_offset_hours" id="display_offset_hours"
                        onclick="document.getElementById('display_using_localtime').checked = true;"
                        onkeypress="document.getElementById('display_using_localtime').checked = true;">
                        
                        {% include "inc_timezone_options.html" %}
                        
                    </select>											
                </div>
                
                <div class="take-note-para end-columns">
                {% if progress >= large_list_html_warning_limit %}
                    <span class="take-note">CAUTION: You have a very large number of tasks. Attempting to display the tasks page may result in the server running out of memory and/or your browser timing out.
                    </span>
                    <br />
                    You may wish to export your tasks first, before attempting to display the tasks page.
                {% endif %}
                </div>
				<button id="display-tasks-button" type="submit" class="big-button" >Display tasks page</button>
			</fieldset>
        </form>
        <div class="break">
        </div>

    {% endif %}


    {% include "inc_project_footer.html" %}

	<div class="backgroundPopup"></div>

</body>
</html>
